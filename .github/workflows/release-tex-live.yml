name: Release TeX Live source image

on:
  schedule:
    - cron: "0 0 25 * *"
  workflow_dispatch:
  push:
    tags:
      - "release-*"

permissions:
  contents: read

jobs:
  context:
    runs-on: ubuntu-latest
    outputs:
      period: ${{ steps.vars.outputs.period }}
      release_tag: ${{ steps.vars.outputs.release_tag }}
      release_name: ${{ steps.vars.outputs.release_name }}
      scope: ${{ steps.vars.outputs.scope }}
    steps:
      - name: Compute release context
        id: vars
        shell: bash
        run: |
          set -euo pipefail
          period=$(date -u +%Y%m)
          release_tag=""
          release_name=""
          scope="all"
          if [[ "${GITHUB_REF_TYPE:-}" == "tag" && "${GITHUB_REF_NAME:-}" == release-* ]]; then
            rest="${GITHUB_REF_NAME#release-}"
            if [[ "$rest" == *"-"* ]]; then
              release_tag="${rest##*-}"
              release_name="${rest%-${release_tag}}"
              scope="name"
            else
              release_tag="$rest"
              scope="all"
            fi
          fi
          echo "period=$period" >> "$GITHUB_OUTPUT"
          echo "release_tag=$release_tag" >> "$GITHUB_OUTPUT"
          echo "release_name=$release_name" >> "$GITHUB_OUTPUT"
          echo "scope=$scope" >> "$GITHUB_OUTPUT"

  build:
    runs-on: ubuntu-latest
    needs: context
    if: needs.context.outputs.scope != 'name' || needs.context.outputs.release_name == 'tex-live'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Extract source image metadata
        id: meta_source
        uses: docker/metadata-action@v5
        with:
          images: ${{ secrets.DOCKER_USERNAME }}/tex-live-src
          tags: |
            type=raw,value=source
            type=raw,value=source-${{ needs.context.outputs.period }}
            type=raw,value=source-${{ needs.context.outputs.release_tag }},enable=${{ needs.context.outputs.release_tag != '' }}

      - name: Extract unpacked image metadata
        id: meta_unpacked
        uses: docker/metadata-action@v5
        with:
          images: ${{ secrets.DOCKER_USERNAME }}/tex-live-src
          tags: |
            type=raw,value=latest
            type=raw,value=${{ needs.context.outputs.period }}
            type=raw,value=${{ needs.context.outputs.release_tag }},enable=${{ needs.context.outputs.release_tag != '' }}

      - name: Build and push source image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          target: source
          push: true
          tags: ${{ steps.meta_source.outputs.tags }}
          labels: ${{ steps.meta_source.outputs.labels }}
          build-args: |
            DOWNLOAD_URL=https://tug.ctan.org/systems/texlive/tlnet/install-tl-unx.tar.gz
            FILE_NAME=install-tl-unx.tar.gz
            ARIA2_OPTIONS=-x 16 -s 16

      - name: Build and push unpacked image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          target: unpacked
          push: true
          tags: ${{ steps.meta_unpacked.outputs.tags }}
          labels: ${{ steps.meta_unpacked.outputs.labels }}
          build-args: |
            DOWNLOAD_URL=https://tug.ctan.org/systems/texlive/tlnet/install-tl-unx.tar.gz
            FILE_NAME=install-tl-unx.tar.gz
            ARIA2_OPTIONS=-x 16 -s 16
